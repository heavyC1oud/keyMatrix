Тестовый проект опроса матричной клавиатуры

Матричная клавиатура 3х4.

|1|2|3| \cr\lf
|4|5|6| \cr\lf
|7|8|9| \cr\lf
|*|0|#| \cr\lf

Микроконтроллер STM32F072.
Тактирование от внутреннего источника частотой 48 МГц.

Столбцы заведены на выводы PORTA[0..2], выводы сконфигурированы как выход с открытым коллектором без подтяжки, по-умолчанию состояние выводов HI-Z.
Строки заведены на выводы PORTB[0..3], выводы сконфигурированы как вход с подтяжкой к питанию.

Первоначальная конфигурация микроконтрллера осуществляется  в функции SystemInit в файле system_stm32f0xx.c.

в качестве защиты от дребезга контактов, используется временная задержка опроса, опрос происходит с периодом в 20 мс, за отсчет времени отвечает таймер SysTick, по прерыванию которого вызывается функция опроса pollMatrix().

Во время опроса поочередно сканируются все столбцы путем установки нуля на соответствующем выводе, затем считываются значения выводов заведенных на строки, где ноль означает нажатие соответствующей кнопки, во время опроса также устанавливаются флаги, с помощью которых в дальнейшем определяются состояния короткого/длинного нажатия, и нажатие двух кнопок.

Разбор результатов опроса происходит в основном цикле программы в функции  keyHandle(), которая, в свою очередь, в случае возникновения определенного события такого как:
- короткое нажатие на одну клавишу
- короткое нажатие на две клавиши
- нажатие и удержание одной клавиши в течении 1 секунды
- нажатие и удержание двух клавиш в течении 1 секунды
будет вызывать необходимую функцию.